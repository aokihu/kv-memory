## Context

当前系统已经实现了记忆链接（links）按 `link weight × memory score` 综合得分排序的功能，但该功能仅通过HTTP API暴露。MCP工具（memory_get, memory_search, memory_fulltext_search）尚未集成这一能力，导致通过MCP协议访问的记忆数据缺乏优化排序。

**当前状态：**
- HTTP API已支持 `sortLinks` 参数（默认true）
- 排序算法已实现：`sortLinksByCombinedScore` 函数
- MCP工具返回原始未排序的links数组
- MCP工具参数schema未包含 `sortLinks` 参数

**约束：**
- 必须保持向后兼容性
- 必须与HTTP API行为一致
- 必须遵循现有的MCP工具架构模式
- 不能破坏现有的MCP客户端

## Goals / Non-Goals

**Goals:**
1. 为MCP工具添加 `sortLinks` 参数支持
2. 默认启用链接排序（与HTTP API一致）
3. 确保MCP工具与HTTP API使用相同的排序逻辑
4. 保持向后兼容性
5. 提供清晰的参数验证和错误处理

**Non-Goals:**
1. 不修改MCP协议本身
2. 不改变现有MCP工具的基本功能
3. 不引入新的外部依赖
4. 不重新实现排序算法（复用现有实现）

## Decisions

### 1. 参数设计决策
**决策**：为MCP工具添加可选的 `sortLinks` 参数，支持boolean和字符串值
**理由**：
- 与HTTP API参数设计保持一致
- 支持灵活的参数传递方式
- 便于MCP客户端集成
**替代方案**：创建新的MCP工具专门用于排序版本（被否决，因为会增加复杂性）

### 2. 默认值决策
**决策**：默认启用排序（`sortLinks: true`）
**理由**：
- 与HTTP API默认行为一致
- 提供更好的用户体验（默认返回排序后的links）
- 符合"智能默认值"设计原则
**替代方案**：默认禁用排序（被否决，因为会降低数据质量）

### 3. 实现方式决策
**决策**：在MCP工具处理层集成排序逻辑
**理由**：
- 复用现有的 `sortLinksByCombinedScore` 函数
- 保持业务逻辑一致性
- 减少代码重复
**替代方案**：在数据库查询层实现（被否决，因为MCP工具使用相同的服务层）

### 4. Schema更新决策
**决策**：更新现有的MCP schema定义
**理由**：
- 保持schema集中管理
- 便于参数验证
- 提供类型安全
**替代方案**：在工具处理函数中手动验证（被否决，因为缺乏类型安全和可维护性）

## Risks / Trade-offs

### 风险1：向后兼容性破坏
**风险**：现有MCP客户端可能不期望links被排序
**缓解措施**：
- 保持默认行为可配置（通过参数）
- 提供清晰的文档说明
- 确保未指定参数时的行为与之前版本一致（通过默认值控制）

### 风险2：性能影响
**风险**：排序操作可能增加MCP工具响应时间
**缓解措施**：
- 复用已优化的排序算法
- 排序操作在内存中进行，数据量可控
- 提供禁用排序的选项

### 风险3：参数验证复杂性
**风险**：需要处理多种参数格式（boolean, string）
**缓解措施**：
- 使用统一的参数解析逻辑
- 提供清晰的错误消息
- 在schema层进行严格验证

### 权衡：功能丰富性 vs 接口简洁性
**权衡**：添加新参数增加了接口复杂性，但提供了更好的功能控制
**决策**：接受适度的接口复杂性，因为排序功能对数据质量有显著提升

## Migration Plan

### 部署步骤
1. **阶段1：开发实现**
   - 更新MCP工具代码
   - 更新schema定义
   - 添加参数验证

2. **阶段2：测试验证**
   - 单元测试：参数验证和排序逻辑
   - 集成测试：MCP工具端到端功能
   - 兼容性测试：确保现有客户端不受影响

3. **阶段3：部署发布**
   - 更新MCP服务器版本
   - 更新文档（MCP-README.md）
   - 监控生产环境表现

### 回滚策略
如果发现问题：
1. 立即回滚到上一个稳定版本
2. 保持 `sortLinks` 参数但默认设置为 `false`
3. 提供临时配置选项禁用排序功能

## Open Questions

1. **MCP工具是否需要支持其他排序参数？**
   - 当前仅支持 `sortLinks`，未来可能需要支持其他排序方式
   - 决策：当前仅实现基本需求，未来可通过扩展参数支持

2. **如何处理大量links的排序性能？**
   - 当前实现假设links数量可控
   - 如果遇到性能问题，可考虑添加分页或限制参数

3. **MCP提示（prompts）是否需要更新？**
   - 当前变更不影响MCP提示
   - 未来可考虑更新提示以反映排序能力